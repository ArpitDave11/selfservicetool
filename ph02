# **PHASE 2: AI SKILLS PARAMETERIZATION & DYNAMIC DIAGRAMS**

### **OBJECTIVES**
1. **Move ALL AI prompts** from `skills.ts` into template definitions
2. **Refactor skills** to be template-aware (no hardcoded logic)
3. **Make diagrams dynamic** - template specifies type, prompts, and generation
4. **Integrate Critique Agent** to validate template compliance
5. **Create Template Editor UI** for managing prompts and diagram config
6. **Remove legacy constants** (`STAGES`, `EPIC_SECTIONS`)

---

## **STEP 2.1: Refactor Template Schema for AI Configuration**

```bash
# Update template schema with AI and diagram config
claude "Update src/templates/schemas/template.types.ts:

1. ADD to TemplateField:
   aiPrompt?: {
     systemPrompt: string;
     userPromptTemplate: string;
     contextFields: string[]; // Fields to include in context
     modeSupport: ('refine' | 'auto')[];
     maxTokens?: number;
     temperature?: number;
   }

2. ADD to EpicTemplate:
   prompts: {
     systemPrompts: Record<string, string>;
     generationPrompt: string;
     diagramPrompt?: string;
     critiquePrompt?: string;
   }
   diagramConfig: {
     supportedTypes: ('c4-container' | 'sequence' | 'deployment' | 'component' | 'plantuml')[];
     defaultType: string;
     generationStrategy: 'ai' | 'rule-based';
     maxNodes: number;
     layout: 'LR' | 'TB';
     fieldExtraction?: {
       components: string[]; // Field IDs for component extraction
       dataStores: string[];
       actors: string[];
     }
   }

3. ADD Critique configuration:
   critiqueConfig?: {
     enabled: boolean;
     rules: string[]; // Custom validation rules
     severity: 'low' | 'medium' | 'high';
   }

4. UPDATE EpicSection:
   dataMappings: string[]; // Field IDs to inject
   formatting: 'table' | 'list' | 'checkbox' | 'subsection' | 'custom';
   template: string; // EJS-like template string

Include JSDoc examples for each new field."
```

---

## **STEP 2.2: Extract Prompts from skills.ts into Default Template**

```bash
# Create migration that extracts prompts
claude "Update src/utils/templates/migrations.ts:

1. ENHANCE convertLegacyToTemplate():
   - Extract ALL system prompts from skills.ts getSystemPromptForField()
   - For each stage.field, add aiPrompt object:
     * systemPrompt: extracted prompt
     * userPromptTemplate: buildUserPrompt logic
     * contextFields: ['projectName', 'objective', 'background']
     * modeSupport: ['refine', 'auto']

2. Add diagramConfig to DEFAULT_TEMPLATE:
   - supportedTypes: ['c4-container', 'sequence', 'deployment', 'component', 'plantuml']
   - defaultType: 'c4-container'
   - generationStrategy: 'ai'
   - maxNodes: 15
   - layout: 'LR'
   - fieldExtraction:
     * components: ['architectureOverview', 'features']
     * dataStores: ['dataStores']
     * actors: ['teams']

3. Add prompts object:
   - systemPrompts: Map of all extracted prompts
   - generationPrompt: Epic generation prompt
   - diagramPrompt: Diagram AI prompt
   - critiquePrompt: Critique rules

4. Create a 'prompts.json' file with all extracted prompts for review

Show me the extracted prompts count per stage/field."
```

---

## **STEP 2.3: Refactor Skill Runner to be Template-Aware**

```bash
# Create new skill runner that uses template prompts
claude "Create src/skills/index.ts:

1. Interface: SkillParams
   template: EpicTemplate
   stageId: string
   fieldId: string
   userInput: string
   context: Record<string, string>
   mode: 'refine' | 'auto'

2. Function: async function runTemplateSkill(
     skill: 'suggest' | 'refine' | 'generate' | 'diagram',
     params: SkillParams
   ): Promise<AIResult>

3. Implementation:
   - Get field from template: const field = template.stages.find(...).fields.find(...)
   - Get prompt from field.aiPrompt.systemPrompt
   - Build user prompt from field.aiPrompt.userPromptTemplate + context
   - Call callAI() with template-specific parameters
   - Return result

4. Function: async function generateEpicFromTemplate(
     template: EpicTemplate,
     stageData: Record<string, any>,
     projectName: string
   ): Promise<GenerateResult>

   - Iterate template.epicStructure
   - For each section:
     * Get template string
     * Replace {{fieldId}} with stageData[fieldId].refined
     * Apply formatting based on section.formatting
   - Call template-aware diagram generation
   - Return epic + diagram

5. Function: async function getSuggestionFromTemplate(...)
   - Use field.aiPrompt for prompt building
   - Respect modeSupport array (disable buttons if not supported)

Include error handling for missing prompts."
```

---

## **STEP 2.4: Create Dynamic Diagram Generation Service**

```bash
# Build template-aware diagram service
claude "Create src/skills/diagrams.ts:

1. Function: async function generateTemplateDiagram(
     template: EpicTemplate,
     stageData: Record<string, any>,
     options?: { type?: DiagramType }
   ): Promise<{ diagram: string; type: DiagramType; reasoning: string }>

2. Implementation:
   - Get diagramConfig from template
   - Determine diagram type (options.type || config.defaultType)
   - If config.generationStrategy === 'ai':
     * Build prompt from template.prompts.diagramPrompt
     * Include stageData, fieldExtraction config
     * Call callAI()
     * Validate and return diagram
   - If 'rule-based':
     * Call appropriate generator based on type
     * Use extracted fields from fieldExtraction config
   - Return diagram + reasoning

3. Function: extractDiagramFields(
     stageData: Record<string, any>,
     extractionConfig: any
   ): { components: string[]; dataStores: string[]; actors: string[] }

   - Extract components from architectureOverview, features
   - Extract data stores from dataStores field
   - Extract actors from teams field
   - Use regex and parsing logic

4. Keep existing generators:
   - generateC4ContainerDiagram()
   - generateSequenceDiagram()
   - generateDeploymentDiagram()
   - generateComponentDiagram()
   - But make them accept extracted fields instead of full data

5. Function: validateMermaidDiagram(diagram: string): boolean
   - Check for valid start keywords
   - Check node syntax
   - Return true/false

Include JSDoc with template diagram prompt example."
```

---

## **STEP 2.5: Integrate Critique Agent**

```bash
# Create Critique Agent service
claude "Create src/skills/critique.ts:

1. Class: CritiqueAgent
   - constructor(template: EpicTemplate)

2. Method: async reviewEpicStructure(
     epicMarkdown: string
   ): Promise<CritiqueResult>

   - Check all required sections present
   - Check required fields populated
   - Validate formatting (tables, checkboxes)
   - Return array of { severity, message, suggestion }

3. Method: async reviewDiagram(
     diagram: string,
     template: EpicTemplate
   ): Promise<CritiqueResult>

   - Validate diagram type is in supportedTypes
   - Check node count <= maxNodes
   - Validate layout matches config
   - Check for Mermaid syntax errors

4. Method: async reviewFieldContent(
     fieldId: string,
     content: string,
     template: EpicTemplate
   ): Promise<CritiqueResult>

   - Check minLength if specified
   - Check for required keywords
   - Validate structure

5. Interface: CritiqueResult
   isValid: boolean
   issues: Array<{
     severity: 'error' | 'warning' | 'info'
     message: string
     suggestion?: string
     fieldId?: string
   }>
   score: number // 0-100

6. Use template.prompts.critiquePrompt for AI review

Include example critique rules from DEFAULT_TEMPLATE."
```

---

## **STEP 2.6: Create Template Editor UI**

```bash
# Build UI for editing template prompts and config
claude "Create src/components/template/TemplateEditor.tsx:

1. Component: TemplateEditor
   - Props: { template: EpicTemplate, onSave: (template) => void }

2. Tabs:
   - 'Info': Name, description, version
   - 'Stages': Reorder/add/delete stages
   - 'Fields': For each field, edit:
     * Label, placeholder, required
     * AI prompt (textarea)
     * Context fields (multi-select)
     * Mode support (checkboxes)
   - 'Sections': Epic structure
   - 'Diagrams': Diagram config
     * Supported types (multi-select)
     * Default type
     * Layout
     * Max nodes
   - 'Critique': Critique rules

3. Use react-hook-form for validation

4. Code editor for prompts (Monaco editor if available)

5. Preview tab: See how template renders

6. Save button: Validates and calls onSave

Include JSON export/import within editor."
```

---

## **STEP 2.7: Update App.tsx with Critique Integration**

```bash
# Add critique to epic generation flow
claude "Modify src/App.tsx:

1. Import CritiqueAgent

2. After generateEpicFromTemplate() in handleGenerateEpic:
   - const critique = new CritiqueAgent(activeTemplate)
   - const review = await critique.reviewEpicStructure(updatedEpic)
   - If review.issues.length > 0:
     * Show toast: 'Epic generated with {n} suggestions'
     * Add button: 'View Critique'
     * Open critique panel

3. Add critique panel UI:
   - Shows issues by severity
   - One-click fix suggestions
   - Apply to epic button

4. After diagram generation:
   - const diagramReview = await critique.reviewDiagram(blueprintCode, activeTemplate)
   - If invalid, show warning toast

5. Track critique metrics over time

This adds quality gate to generation."
```

---

## **STEP 2.8: Remove Legacy Constants (CAREFULLY)**

```bash
# Remove hardcoded STAGES and EPIC_SECTIONS
claude "Modify src/types/types.ts:

1. REMOVE:
   - STAGES array
   - EPIC_SECTIONS array
   - getSystemPromptForField function
   - buildUserPrompt function

2. KEEP (but mark deprecated):
   - LegacyStage interface
   - LegacyEpicSection interface
   - Comment: // @deprecated - Removed in Phase 2, use EpicTemplate

3. Update any remaining imports in other files:
   - Find all references to STAGES/EPIC_SECTIONS
   - Replace with useTemplate() hook
   - Run TypeScript compiler to catch errors

This is BREAKING - ensure all files updated first."
```

---

## **STEP 2.9: Update Skills.ts to Remove Hardcoded Logic**

```bash
# Remove old functions, keep only template-aware ones
claude "Refactor src/skills.ts:

KEEP:
- setConfig()
- callAI() (but mark as internal)
- generateIntelligentBlueprint() (refactor to use template)
- fixMermaidDiagram()

REMOVE:
- getSystemPromptForField() (moved to template)
- buildUserPrompt() (moved to template)
- runSkill() (replaced by runTemplateSkill)
- refineInput() (replaced by template logic)
- generateEpic() (replaced by generateEpicFromTemplate)

MODIFY:
- generateIntelligentBlueprint(): Accept template param
- All diagram generators: Accept extracted fields param

Add deprecation notices and point to new functions."
```

---

## **STEP 2.10: Create Template Gallery UI**

```bash
# Create UI for browsing and selecting templates
claude "Create src/components/template/TemplateGallery.tsx:

1. Component: TemplateGallery
   - Shows all registered templates
   - Grid layout with cards

2. Each template card shows:
   - Name and description
   - Stage count
   - Section count
   - GitLab icon if sourced from GitLab
   - 'Use Template' button

3. Features:
   - Search/filter by name/category
   - Sort by name, last used
   - Preview template (opens TemplateEditor in read-only)
   - Import from GitLab (opens EpicSelector)

4. Use useTemplate() to get list and switch

Include empty state: 'No templates yet. Import from GitLab or create new.'"
```

---

## **STEP 2.11: Update Migration to Include All AI Logic**

```bash
# Ensure migration extracts everything
claude "Verify src/utils/templates/migrations.ts:

Double-check that convertLegacyToTemplate() extracts:

1. ALL system prompts from skills.ts (should be ~30 prompts)
2. Generation prompt from generateEpic()
3. Diagram prompts from generateIntelligentBlueprint()
4. Critique rules (create default set)
5. Field-specific context fields
6. Mode support for each field

Add any missing prompts. Create MIGRATION_SUMMARY object:
export const MIGRATION_SUMMARY = {
  promptsExtracted: 32,
  stagesConverted: 6,
  sectionsConverted: 17,
  diagramConfigs: 5
};

Add console.log on import to show migration stats."
```

---

## **STEP 2.12: Create Comprehensive Tests for Skills**

```bash
# Test all new skill functions
claude "Create src/skills/__tests__/skills.test.ts:

Test suites:

1. 'runTemplateSkill'
   - Uses template prompts correctly
   - Respects modeSupport
   - Builds context from contextFields
   - Returns structured result

2. 'generateEpicFromTemplate'
   - Renders all sections from template
   - Applies correct formatting
   - Calls diagram generation
   - Returns epic + diagram

3. 'generateTemplateDiagram'
   - Uses AI strategy when configured
   - Uses rule-based when configured
   - Extracts fields correctly
   - Returns valid diagram

4. 'CritiqueAgent'
   - Reviews epic structure
   - Reviews diagram
   - Returns valid CritiqueResult
   - Score calculation

5. 'extractDiagramFields'
   - Parses architectureOverview
   - Parses dataStores
   - Parses teams
   - Returns structured data

Use jest mocks for callAI(). Include fixture templates."
```

---

## **STEP 2.13: Commit Phase 2**

```bash
# Commit the AI parameterization
claude "Execute:
git add -A
git commit -m 'feat: Phase 2 - AI Skills Parameterization & Dynamic Diagrams

Transform hardcoded AI into template-driven system:

- Template schema enhanced with aiPrompt and diagramConfig
- All AI prompts migrated from skills.ts to DEFAULT_TEMPLATE
- runTemplateSkill() - template-aware skill runner
- generateTemplateDiagram() - dynamic diagram generation
- CritiqueAgent - validates templates and output
- TemplateEditor UI for managing prompts and config
- TemplateGallery for browsing templates
- Legacy constants (STAGES/EPIC_SECTIONS) removed
- Skills.ts refactored to pure template functions

BREAKING CHANGE: STAGES and EPIC_SECTIONS removed from types.ts
All AI logic now requires EpicTemplate context
Closes: phase2-ai-parameterization'
"
```

---

## **PHASE 2 DELIVERABLES**

✅ **Template AI Config**: Every field has aiPrompt object  
✅ **Dynamic Skills**: All logic reads from template.prompts  
✅ **Dynamic Diagrams**: Template specifies type, prompts, layout  
✅ **Critique Agent**: Validates structure, diagram, content  
✅ **Template Editor**: UI to edit prompts, diagram config, critique rules  
✅ **Template Gallery**: Browse and select templates  
✅ **Legacy Removal**: STAGES/EPIC_SECTIONS deleted  
✅ **Refactored Skills**: No hardcoded logic, pure functions  
✅ **Tests**: Comprehensive skill and agent tests  

---

## **WHAT CHANGES IN USAGE**

### **Before Phase 2:**
```typescript
// Hardcoded prompt
const prompt = getSystemPromptForField('project', 'background');
```

### **After Phase 2:**
```typescript
// Template-driven
const field = template.stages[0].fields[1];
const prompt = field.aiPrompt?.systemPrompt;
```

### **Before Phase 2:**
```typescript
// Fixed diagram type
const diagram = generateC4ContainerDiagram(data);
```

### **After Phase 2:**
```typescript
// Template-driven
const { diagram, type } = await generateTemplateDiagram(template, stageData);
```

---

## **READY FOR PHASE 3?**

**Phase 3** will focus on:
1. **Advanced Template Features**: Conditional fields, field dependencies, dynamic sections
2. **Template Marketplace**: Share templates via GitLab
3. **Analytics**: Track template usage, AI suggestion quality
4. **Performance**: Optimize large templates, lazy loading
5. **Collaboration**: Multi-user template editing

**Proceed with Phase 3?**
